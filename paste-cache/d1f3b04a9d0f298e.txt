{"type":"TASK","data":{"input":{"url":"https://n8n.atgfw.com/webhook/llm-data-extraction","body":"{%- set ct_raw = CTX.call_transcript -%}{%- set ct = ct_raw|from_yaml_string if ct_raw is string else ct_raw|d({}) -%}{%- set transcript_entries = ct.transcript|d([]) -%}{%- set transcript_lines = [] -%}{%- for turn in transcript_entries -%}  {%- set turn_text = turn.text|d('')|string -%}  {%- if turn_text and turn_text|lower not in ['','none','null'] -%}    {%- set role_label = 'Agent' if turn.role == 'agent' else 'Caller' -%}    {%- set _ = transcript_lines.append(role_label ~ ': ' ~ turn_text) -%}  {%- endif -%}{%- endfor -%}{%- set transcript_text = transcript_lines|join('\\n') -%}{%- set occ_vars = CTX.occ_settings.vars|d({}) -%}{%- set prefs_slim = {  'company_name': occ_vars.occ_notification_routing_preferences.company.company_name|d(''),  'locations': occ_vars.occ_notification_routing_preferences.locations|d([])|map(attribute='location_name')|list,  'departments': []} -%}{%- for loc in occ_vars.occ_notification_routing_preferences.locations|d([]) -%}  {%- for dept in loc.departments|d([]) -%}    {%- if dept.department_name|d('') not in prefs_slim.departments -%}      {%- set _ = prefs_slim.departments.append(dept.department_name) -%}    {%- endif -%}  {%- endfor -%}{%- endfor -%}{{ {  'input_data': transcript_text,  'categories': ['caller', 'contact', 'routing', 'request'],  'source_metadata': {    'conversation_id': ct.conversation_id|d(CTX.conversation_id)|d(''),    'agent_id': ct.agent_id|d(CTX.agent_id)|d(''),    'session_id': CTX.session_id|d(''),    'duration_secs': ct.call.duration_secs|d(CTX.call_duration_secs)|d(0),    'channel': 'voice',    'company_config': prefs_slim  },  'llm_config': {    'model': 'gpt-5.2',    'temperature': 0.1  }}|tojson }}","json":null,"files":[],"method":"POST","params":null,"cookies":null,"headers":{"Content-Type":"application/json","x-rewst-secret":"asdasdasdasdasdasdasdasdjkyhvltycfiy57dr6976t"},"timeout":5,"auth_password":null,"auth_username":null,"allow_redirects":true,"require_2xx_status":null},"isMocked":false,"mockInput":{"mock_result":{}},"id":"29bf9b4a7247420dbf44c02bb3114d7d","join":0,"metadata":{"x":2602.7,"y":456},"workflowId":"019a0806-cd55-7abc-bdc5-095263c19fab","humanSecondsSaved":0,"transitionMode":"FOLLOW_FIRST","packOverrides":[],"publishResultAs":"llm_extraction_result","runAsOrgId":"","with":null,"next":[{"id":"570f2365-994d-4cb1-a3a3-a68ccf5f2c22","when":"","do":[],"publish":[{"key":"llm_extraction_result","value":"{#- =========================================================\r\n    LLM EXTRACTION RESULT NORMALIZER\r\n    Merges LLM extraction with ElevenLabs BDA fallback\r\n    Output: Unified structure matching legacy BDA format\r\n    ========================================================= -#}\r\n{%- set llm_raw = CTX.llm_extraction_result|d({}) -%}\r\n{%- set llm_data = llm_raw.data.data|d(llm_raw.data.extraction_results|d({})) -%}\r\n{%- set el_bda = CTX.elevenlabs_body_data_analysis|d({}) -%}\r\n{%- set el_dcr = el_bda.data_collection_results|d({}) -%}\r\n{%- set invalid = ['','none','null','undefined','error','unknown'] -%}\r\n\r\n{#- Helper: Get first valid value from LLM then ElevenLabs -#}\r\n{%- macro first_valid(llm_val, el_obj) -%}\r\n  {%- set lv = llm_val|d(None) -%}\r\n  {%- set ev = el_obj.value|d(None) if el_obj is mapping else el_obj -%}\r\n  {%- set lv_ok = lv is not none and lv|string|lower|trim not in invalid -%}\r\n  {%- set ev_ok = ev is not none and ev|string|lower|trim not in invalid -%}\r\n  {{- lv if lv_ok else (ev if ev_ok else None) -}}\r\n{%- endmacro -%}\r\n\r\n{#- Extract LLM categories -#}\r\n{%- set llm_caller = llm_data.get('caller', {}) -%}\r\n{%- set llm_contact = llm_data.get('contact', {}) -%}\r\n{%- set llm_routing = llm_data.get('routing', {}) -%}\r\n{%- set llm_request = llm_data.get('request', {}) -%}\r\n\r\n{#- Build normalized output matching legacy dcr.*.value structure -#}\r\n{{ {\r\n  'caller': {\r\n    'first_name': {'value': first_valid(llm_caller.get('caller_first_name', llm_caller.get('first_name')), el_dcr.get('caller_first_name', {}))},\r\n    'last_name': {'value': first_valid(llm_caller.get('caller_last_name', llm_caller.get('last_name')), el_dcr.get('caller_last_name', {}))},\r\n    'company_name': {'value': first_valid(llm_caller.get('company_name'), el_dcr.get('company_name', {}))}\r\n  },\r\n  'contact': {\r\n    'first_name': {'value': first_valid(llm_contact.get('contact_first_name', llm_contact.get('first_name')), el_dcr.get('contact_first_name', {}))},\r\n    'last_name': {'value': first_valid(llm_contact.get('contact_last_name', llm_contact.get('last_name')), el_dcr.get('contact_last_name', {}))},\r\n    'phone': {'value': first_valid(llm_contact.get('contact_phone', llm_contact.get('phone')), el_dcr.get('contact_phone', {}))},\r\n    'email': {'value': first_valid(llm_contact.get('contact_email', llm_contact.get('email')), el_dcr.get('contact_email', {}))},\r\n    'preferred_channel': {'value': first_valid(llm_contact.get('contact_preferred_channel', llm_contact.get('preferred_channel')), el_dcr.get('contact_preferred_channel', {}))},\r\n    'caller_is_contact': {'value': llm_contact.get('caller_is_contact', true)}\r\n  },\r\n  'routing': {\r\n    'department': {'value': first_valid(llm_routing.get('department'), el_dcr.get('department', {}))},\r\n    'site_location_name': {'value': first_valid(llm_routing.get('site_location_name'), el_dcr.get('site_location_name', {}))},\r\n    'contact_group_name': {'value': first_valid(llm_routing.get('routing_group_name', llm_routing.get('contact_group_name')), el_dcr.get('contact_group_name', {}))},\r\n    'routing_group_name': {'value': first_valid(llm_routing.get('routing_group_name'), el_dcr.get('routing_group_name', {}))},\r\n    'requested_person': {'value': llm_routing.get('requested_person')},\r\n    'call_transferred': {'value': llm_routing.get('call_transferred', false)},\r\n    'call_transfer_destination': {'value': llm_routing.get('call_transfer_destination')},\r\n    'transfer_reason': {'value': llm_routing.get('transfer_reason')}\r\n  },\r\n  'request': {\r\n    'summary': {'value': first_valid(llm_request.get('request_summary', llm_request.get('summary')), el_dcr.get('request_summary', {}))},\r\n    'detailed_description': {'value': first_valid(llm_request.get('detailed_description'), el_dcr.get('detailed_description', {}))},\r\n    'affected_asset': {'value': first_valid(llm_request.get('affected_asset'), el_dcr.get('affected_asset', {}))},\r\n    'requested_due_date': {'value': first_valid(llm_request.get('requested_due_date'), el_dcr.get('requested_due_date', {}))},\r\n    'service_address': {'value': first_valid(llm_request.get('service_address'), el_dcr.get('service_address', {}))},\r\n    'requested_visit_type': {'value': llm_request.get('requested_visit_type', 'routine')}\r\n  },\r\n  '_meta': {\r\n    'source': 'llm_primary' if llm_raw.data.success|d(false) else 'elevenlabs_fallback',\r\n    'extraction_id': llm_raw.data.extraction_id|d(None),\r\n    'model': llm_raw.data.model_used|d('unknown')\r\n  }\r\n} }}"},{"key":"contact_group_name","value":"{%- set lde = CTX.llm_extraction_result|d({}) -%}\r\n{%- set dcr = {\r\n  'site_location_name': {'value': lde.routing.site_location_name.value|d(none, true)},\r\n  'department': {'value': lde.routing.department.value|d(none, true)},\r\n  'contact_group_name': {'value': lde.routing.contact_group_name.value|d(none, true)},\r\n  'routing_group_name': {'value': lde.routing.routing_group_name.value|d(none, true)}\r\n} -%}\r\n{%- set vars = CTX.occ_settings.vars|d({}) -%}\r\n{%- set prefs = CTX.occ_notification_routing_preferences|d({}) -%}\r\n{%- set invalid = ['','none','null','undefined','error','unknown'] -%}\r\n{%- set def_loc_from_schema = (prefs.company.locations|d([]))|selectattr('is_default', 'eq', true)|map(attribute='location_name')|first|d(none, true) -%}\r\n{%- set def_loc_from_vars = vars.occ_global_default_location|d(none, true) -%}\r\n{%- set def_loc = def_loc_from_schema if def_loc_from_schema else def_loc_from_vars -%}\r\n{%- set def_dept_obj = ((prefs.company.locations|d([]))|selectattr('is_default', 'eq', true)|first|d({})).departments|d([])|selectattr('is_default', 'eq', true)|first|d({}) -%}\r\n{%- set def_dept_from_schema = def_dept_obj.department_name|d(none, true) -%}\r\n{%- set def_dept_from_vars = vars.occ_global_default_department|d(none, true) -%}\r\n{%- set def_dept = def_dept_from_schema if def_dept_from_schema else def_dept_from_vars -%}\r\n{%- set valid_locations = [] -%}\r\n{%- set location_name_map = {} -%}\r\n{%- set valid_departments = [] -%}\r\n{%- set department_name_map = {} -%}\r\n{%- for loc in prefs.company.locations|d([]) -%}\r\n  {%- if loc.enabled|d(true) -%}\r\n    {%- if loc.location_name|d(none, true) -%}\r\n      {%- set loc_key = loc.location_name|string|lower|trim -%}\r\n      {%- set _ = valid_locations.append(loc_key) -%}\r\n      {%- set _ = location_name_map.update({loc_key: loc.location_name}) -%}\r\n    {%- endif -%}\r\n    {%- for dept in loc.departments|d([]) -%}\r\n      {%- if dept.enabled|d(true) and dept.department_name|d(none, true) -%}\r\n        {%- set dept_key = dept.department_name|string|lower|trim -%}\r\n        {%- set _ = valid_departments.append(dept_key) -%}\r\n        {%- set _ = department_name_map.update({dept_key: dept.department_name}) -%}\r\n      {%- endif -%}\r\n    {%- endfor -%}\r\n  {%- endif -%}\r\n{%- endfor -%}\r\n{%- set ai_loc = lde.routing.site_location_name.value|d(none, true) -%}\r\n{%- set ai_dept = lde.routing.department.value|d(none, true) -%}\r\n{%- set ai_cg = lde.routing.contact_group_name.value|d(none, true) -%}\r\n{%- set ai_rg = lde.routing.routing_group_name.value|d(none, true) -%}\r\n{%- set ai_loc_basic_valid = ai_loc and ai_loc|string|lower|trim not in invalid and 'error' not in (ai_loc|string|lower) -%}\r\n{%- set ai_loc_key = ai_loc|string|lower|trim if ai_loc_basic_valid else none -%}\r\n{%- set ai_loc_in_schema = ai_loc_key and ai_loc_key in valid_locations -%}\r\n{%- set ai_loc_valid = ai_loc_basic_valid and (ai_loc_in_schema or (valid_locations|length == 0)) -%}\r\n{%- set ai_dept_basic_valid = ai_dept and ai_dept|string|lower|trim not in invalid and 'error' not in (ai_dept|string|lower) -%}\r\n{%- set ai_dept_key = ai_dept|string|lower|trim if ai_dept_basic_valid else none -%}\r\n{%- set ai_dept_in_schema = ai_dept_key and ai_dept_key in valid_departments -%}\r\n{%- set ai_dept_valid = ai_dept_basic_valid and (ai_dept_in_schema or (valid_departments|length == 0)) -%}\r\n{%- set ai_cg_valid = ai_cg and ai_cg|string|lower|trim not in invalid and 'error' not in (ai_cg|string|lower) -%}\r\n{%- set ai_rg_valid = ai_rg and ai_rg|string|lower|trim not in invalid and 'error' not in (ai_rg|string|lower) -%}\r\n{%- set threecx_loc = CTX.threecx_calls.threecx_location_name|d(none, true) -%}\r\n{%- set threecx_loc_basic_valid = threecx_loc and threecx_loc|string|lower|trim not in invalid -%}\r\n{%- set threecx_loc_key = threecx_loc|string|lower|trim if threecx_loc_basic_valid else none -%}\r\n{%- set threecx_loc_in_schema = threecx_loc_key and threecx_loc_key in valid_locations -%}\r\n{%- set threecx_loc_valid = threecx_loc_basic_valid and (threecx_loc_in_schema or (valid_locations|length == 0)) -%}\r\n{%- set current_loc = ai_loc if ai_loc_valid else def_loc -%}\r\n{%- set current_dept = ai_dept if ai_dept_valid else def_dept -%}\r\n{%- set def_loc_key = def_loc|string|lower|trim if def_loc else none -%}\r\n{%- set caller_specified_loc = ai_loc_valid and def_loc_key and ai_loc_key != def_loc_key -%}\r\n{%- set ai_dept_key_cmp = ai_dept|string|lower|trim if ai_dept_valid else none -%}\r\n{%- set def_dept_key = def_dept|string|lower|trim if def_dept else none -%}\r\n{%- set caller_specified_dept = ai_dept_valid and def_dept_key and ai_dept_key_cmp != def_dept_key -%}\r\n{%- set current_loc_key = current_loc|string|lower|trim if current_loc else none -%}\r\n{%- set threecx_differs = threecx_loc_valid and current_loc_key and threecx_loc_key != current_loc_key -%}\r\n{%- set apply_threecx_loc_override = (not caller_specified_loc) and threecx_loc_valid and threecx_differs -%}\r\n{%- set raw_final_loc = threecx_loc if apply_threecx_loc_override else current_loc -%}\r\n{%- set raw_final_dept = current_dept -%}\r\n{%- set final_loc_key = raw_final_loc|string|lower|trim if raw_final_loc else none -%}\r\n{%- set final_dept_key = raw_final_dept|string|lower|trim if raw_final_dept else none -%}\r\n{%- set final_loc = location_name_map.get(final_loc_key, raw_final_loc) if final_loc_key else raw_final_loc -%}\r\n{%- set final_dept = department_name_map.get(final_dept_key, raw_final_dept) if final_dept_key else raw_final_dept -%}\r\n{%- if ai_cg_valid -%}\r\n  {{- ai_cg -}}\r\n{%- elif ai_rg_valid -%}\r\n  {{- ai_rg -}}\r\n{%- elif final_loc and final_dept -%}\r\n  {%- set built = (final_loc ~ ' ' ~ final_dept)|trim -%}\r\n  {%- if built and built|string|lower|trim not in invalid -%}\r\n    {{- built -}}\r\n  {%- else -%}\r\n    {{- (def_loc ~ ' ' ~ def_dept)|trim if def_loc and def_dept else none -}}\r\n  {%- endif -%}\r\n{%- elif final_loc -%}\r\n  {{- (final_loc ~ ' ' ~ def_dept)|trim if def_dept else final_loc -}}\r\n{%- elif final_dept -%}\r\n  {{- (def_loc ~ ' ' ~ final_dept)|trim if def_loc else final_dept -}}\r\n{%- else -%}\r\n  {{- (def_loc ~ ' ' ~ def_dept)|trim if def_loc and def_dept else none -}}\r\n{%- endif -%}"}],"label":"","__typename":"WorkflowTransition"}],"retry":null,"actionId":"8c2c3c94-1aee-4a32-9939-01f949e76014","action":{"id":"8c2c3c94-1aee-4a32-9939-01f949e76014","name":"HTTP Request","defaultHumanSecondsSaved":0,"description":"Perform an HTTP request","parameters":{"url":{"type":"string","label":"URL","required":true},"body":{"type":"string","label":"Body","coerce":false,"description":"Body to send with the request"},"json":{"type":"object","label":"JSON","description":"JSON body to send with request"},"files":{"type":"array","items":{"type":"object","properties":{"name":{"type":"string","label":"Field Name","required":true,"description":"Name of form field (not filename)"},"contents":{"type":"string","label":"File Contents","description":"Contents of file to upload"},"filename":{"type":"string","label":"File Name","description":"Name of file"},"from_url":{"type":"string","label":"File URL","description":"Publicly-accessible URL to file contents to upload"},"content_type":{"type":"string","label":"Content Type","description":"mimetype of file to include in multipart field"}}},"label":"Files","description":"Files to upload using multipart/form-data"},"method":{"enum":["HEAD","GET","POST","PUT","DELETE","OPTIONS","TRACE","PATCH","PURGE"],"type":"string","label":"Request Method","default":"GET","required":true,"description":"HTTP method to use."},"params":{"type":"object","label":"Params","description":"Query params to be used with the HTTP request."},"cookies":{"type":"object","label":"Cookies","description":"Cookies to send with request"},"headers":{"type":"object","label":"Headers","description":"Custom HTTP headers to be sent with the request"},"timeout":{"type":"number","label":"Timeout","default":5,"description":"Timeout for the HTTP request (seconds)."},"auth_password":{"type":"string","label":"Auth Password","secret":true,"description":"The password to be used for basic HTTP Authentication"},"auth_username":{"type":"string","label":"Auth Username","description":"The username to be used for basic HTTP Authentication"},"allow_redirects":{"type":"boolean","label":"Allow Redirects","default":true},"require_2xx_status":{"type":"boolean","label":"Require Success Status","description":"Fail the task if a non-2xx HTTP status code is returned"}},"ref":"core.http_request","icon":null,"category":"HTTP Request","workflow":null,"pack":{"id":"79e0db69-f801-4a61-ba1f-0aa472038528","name":"Core","ref":"core","icon":null,"packType":"default","status":"published","__typename":"Pack"},"outputSchema":{},"deprecated":false,"deprecationMessage":"","enabled":true,"runner":{"name":"python-script","__typename":"Runner"},"__typename":"Action"},"name":"llm_data_extraction","description":"Perform an HTTP request","timeout":600,"securitySchema":{"redact":{"input":["auth_password"],"result":[]}},"__typename":"WorkflowTask"}}