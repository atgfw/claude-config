{"type":"TASK","data":{"__typename":"WorkflowTask","input":{"url":"https://n8n.atgfw.com/webhook/llm-data-extraction","body":"{%- set bda = CTX.elevenlabs_body_data_analysis|from_yaml_string if CTX.elevenlabs_body_data_analysis is string else CTX.elevenlabs_body_data_analysis|d({}) -%}\r\n{%- set ct = CTX.call_transcript|from_yaml_string if CTX.call_transcript is string else CTX.call_transcript|d({}) -%}\r\n{%- set dcr_raw = bda.data_collection_results|d({}) -%}\r\n{%- set dcr_slim = {} -%}\r\n{%- for key, field in dcr_raw.items() -%}\r\n  {%- set _ = dcr_slim.update({key: {'value': field.value|d(none), 'rationale': field.rationale|d('')}}) -%}\r\n{%- endfor -%}\r\n{%- set ecr_raw = bda.evaluation_criteria_results|d({}) -%}\r\n{%- set ecr_slim = {} -%}\r\n{%- for key, field in ecr_raw.items() -%}\r\n  {%- set _ = ecr_slim.update({key: {'result': field.result|d(''), 'rationale': field.rationale|d('')}}) -%}\r\n{%- endfor -%}\r\n{{ ({\r\n  \"input_data\": {\r\n    \"call_successful\": bda.call_successful|d(''),\r\n    \"call_summary_title\": bda.call_summary_title|d(''),\r\n    \"transcript_summary\": bda.transcript_summary|d(''),\r\n    \"data_collection_results\": dcr_slim,\r\n    \"evaluation_criteria_results\": ecr_slim\r\n  },\r\n  \"categories\": [\"sales\"],\r\n  \"source_metadata\": {\r\n    \"conversation_id\": ct.conversation_id|d(CTX.conversation_id)|d(''),\r\n    \"agent_id\": ct.agent_id|d(CTX.agent_id)|d(''),\r\n    \"session_id\": CTX.session_id|d(''),\r\n    \"company_name\": CTX.company_name|d(''),\r\n    \"caller_name\": ((CTX.caller_first_name|d('')) ~ ' ' ~ (CTX.caller_last_name|d('')))|trim,\r\n    \"duration_secs\": ct.call.duration_secs|d(CTX.call_duration_secs)|d(0),\r\n    \"threecx_calls\": CTX.threecx_calls|d,\r\n    \"occ_settings\": CTX.occ_settings|d,\r\n    \"channel\": \"voice\"\r\n  }\r\n})|tojson }}","json":null,"files":[],"method":"POST","params":null,"cookies":null,"headers":null,"timeout":5,"auth_password":null,"auth_username":null,"allow_redirects":true,"require_2xx_status":null},"isMocked":false,"mockInput":{"mock_result":{}},"id":"9bc6b2c64b984e87929621f772b9d6cb","join":0,"metadata":{"x":2602.7,"y":456},"workflowId":"019a0806-cd55-7abc-bdc5-095263c19fab","humanSecondsSaved":0,"transitionMode":"FOLLOW_FIRST","packOverrides":[],"publishResultAs":"","runAsOrgId":"","with":null,"next":[{"__typename":"WorkflowTransition","id":"7e65540a-33e3-46f8-81a5-567f9d2ffeb9","when":"","do":[],"publish":[{"key":"contact_group_name","value":"{%- set dcr = CTX.elevenlabs_body_data_analysis.data_collection_results|d({}) -%}\r\n{%- set vars = CTX.occ_settings.vars|d({}) -%}\r\n{%- set prefs = CTX.occ_notification_routing_preferences|d({}) -%}\r\n{%- set invalid = ['','none','null','undefined','error','unknown'] -%}\r\n{%- set def_loc_from_schema = (prefs.company.locations|d([]))|selectattr('is_default', 'eq', true)|map(attribute='location_name')|first|d(none, true) -%}\r\n{%- set def_loc_from_vars = vars.occ_global_default_location|d(none, true) -%}\r\n{%- set def_loc = def_loc_from_schema if def_loc_from_schema else def_loc_from_vars -%}\r\n{%- set def_dept_obj = ((prefs.company.locations|d([]))|selectattr('is_default', 'eq', true)|first|d({})).departments|d([])|selectattr('is_default', 'eq', true)|first|d({}) -%}\r\n{%- set def_dept_from_schema = def_dept_obj.department_name|d(none, true) -%}\r\n{%- set def_dept_from_vars = vars.occ_global_default_department|d(none, true) -%}\r\n{%- set def_dept = def_dept_from_schema if def_dept_from_schema else def_dept_from_vars -%}\r\n{%- set valid_locations = [] -%}\r\n{%- set location_name_map = {} -%}\r\n{%- set valid_departments = [] -%}\r\n{%- set department_name_map = {} -%}\r\n{%- for loc in prefs.company.locations|d([]) -%}\r\n  {%- if loc.enabled|d(true) -%}\r\n    {%- if loc.location_name|d(none, true) -%}\r\n      {%- set loc_key = loc.location_name|string|lower|trim -%}\r\n      {%- set _ = valid_locations.append(loc_key) -%}\r\n      {%- set _ = location_name_map.update({loc_key: loc.location_name}) -%}\r\n    {%- endif -%}\r\n    {%- for dept in loc.departments|d([]) -%}\r\n      {%- if dept.enabled|d(true) and dept.department_name|d(none, true) -%}\r\n        {%- set dept_key = dept.department_name|string|lower|trim -%}\r\n        {%- set _ = valid_departments.append(dept_key) -%}\r\n        {%- set _ = department_name_map.update({dept_key: dept.department_name}) -%}\r\n      {%- endif -%}\r\n    {%- endfor -%}\r\n  {%- endif -%}\r\n{%- endfor -%}\r\n{%- set ai_loc = dcr.site_location_name.value|d(none, true) -%}\r\n{%- set ai_dept = dcr.department.value|d(none, true) -%}\r\n{%- set ai_cg = dcr.contact_group_name.value|d(none, true) -%}\r\n{%- set ai_rg = dcr.routing_group_name.value|d(none, true) -%}\r\n{%- set ai_loc_basic_valid = ai_loc and ai_loc|string|lower|trim not in invalid and 'error' not in (ai_loc|string|lower) -%}\r\n{%- set ai_loc_key = ai_loc|string|lower|trim if ai_loc_basic_valid else none -%}\r\n{%- set ai_loc_in_schema = ai_loc_key and ai_loc_key in valid_locations -%}\r\n{%- set ai_loc_valid = ai_loc_basic_valid and (ai_loc_in_schema or (valid_locations|length == 0)) -%}\r\n{%- set ai_dept_basic_valid = ai_dept and ai_dept|string|lower|trim not in invalid and 'error' not in (ai_dept|string|lower) -%}\r\n{%- set ai_dept_key = ai_dept|string|lower|trim if ai_dept_basic_valid else none -%}\r\n{%- set ai_dept_in_schema = ai_dept_key and ai_dept_key in valid_departments -%}\r\n{%- set ai_dept_valid = ai_dept_basic_valid and (ai_dept_in_schema or (valid_departments|length == 0)) -%}\r\n{%- set ai_cg_valid = ai_cg and ai_cg|string|lower|trim not in invalid and 'error' not in (ai_cg|string|lower) -%}\r\n{%- set ai_rg_valid = ai_rg and ai_rg|string|lower|trim not in invalid and 'error' not in (ai_rg|string|lower) -%}\r\n{%- set threecx_loc = CTX.threecx_calls.threecx_location_name|d(none, true) -%}\r\n{%- set threecx_loc_basic_valid = threecx_loc and threecx_loc|string|lower|trim not in invalid -%}\r\n{%- set threecx_loc_key = threecx_loc|string|lower|trim if threecx_loc_basic_valid else none -%}\r\n{%- set threecx_loc_in_schema = threecx_loc_key and threecx_loc_key in valid_locations -%}\r\n{%- set threecx_loc_valid = threecx_loc_basic_valid and (threecx_loc_in_schema or (valid_locations|length == 0)) -%}\r\n{%- set current_loc = ai_loc if ai_loc_valid else def_loc -%}\r\n{%- set current_dept = ai_dept if ai_dept_valid else def_dept -%}\r\n{%- set def_loc_key = def_loc|string|lower|trim if def_loc else none -%}\r\n{%- set caller_specified_loc = ai_loc_valid and def_loc_key and ai_loc_key != def_loc_key -%}\r\n{%- set ai_dept_key_cmp = ai_dept|string|lower|trim if ai_dept_valid else none -%}\r\n{%- set def_dept_key = def_dept|string|lower|trim if def_dept else none -%}\r\n{%- set caller_specified_dept = ai_dept_valid and def_dept_key and ai_dept_key_cmp != def_dept_key -%}\r\n{%- set current_loc_key = current_loc|string|lower|trim if current_loc else none -%}\r\n{%- set threecx_differs = threecx_loc_valid and current_loc_key and threecx_loc_key != current_loc_key -%}\r\n{%- set apply_threecx_loc_override = (not caller_specified_loc) and threecx_loc_valid and threecx_differs -%}\r\n{%- set raw_final_loc = threecx_loc if apply_threecx_loc_override else current_loc -%}\r\n{%- set raw_final_dept = current_dept -%}\r\n{%- set final_loc_key = raw_final_loc|string|lower|trim if raw_final_loc else none -%}\r\n{%- set final_dept_key = raw_final_dept|string|lower|trim if raw_final_dept else none -%}\r\n{%- set final_loc = location_name_map.get(final_loc_key, raw_final_loc) if final_loc_key else raw_final_loc -%}\r\n{%- set final_dept = department_name_map.get(final_dept_key, raw_final_dept) if final_dept_key else raw_final_dept -%}\r\n{%- if ai_cg_valid -%}\r\n  {{- ai_cg -}}\r\n{%- elif ai_rg_valid -%}\r\n  {{- ai_rg -}}\r\n{%- elif final_loc and final_dept -%}\r\n  {%- set built = (final_loc ~ ' ' ~ final_dept)|trim -%}\r\n  {%- if built and built|string|lower|trim not in invalid -%}\r\n    {{- built -}}\r\n  {%- else -%}\r\n    {{- (def_loc ~ ' ' ~ def_dept)|trim if def_loc and def_dept else none -}}\r\n  {%- endif -%}\r\n{%- elif final_loc -%}\r\n  {{- (final_loc ~ ' ' ~ def_dept)|trim if def_dept else final_loc -}}\r\n{%- elif final_dept -%}\r\n  {{- (def_loc ~ ' ' ~ final_dept)|trim if def_loc else final_dept -}}\r\n{%- else -%}\r\n  {{- (def_loc ~ ' ' ~ def_dept)|trim if def_loc and def_dept else none -}}\r\n{%- endif -%}"}],"label":""}],"retry":null,"actionId":"8c2c3c94-1aee-4a32-9939-01f949e76014","action":{"__typename":"Action","id":"8c2c3c94-1aee-4a32-9939-01f949e76014","name":"HTTP Request","defaultHumanSecondsSaved":0,"description":"Perform an HTTP request","parameters":{"url":{"type":"string","label":"URL","required":true},"body":{"type":"string","label":"Body","coerce":false,"description":"Body to send with the request"},"json":{"type":"object","label":"JSON","description":"JSON body to send with request"},"files":{"type":"array","items":{"type":"object","properties":{"name":{"type":"string","label":"Field Name","required":true,"description":"Name of form field (not filename)"},"contents":{"type":"string","label":"File Contents","description":"Contents of file to upload"},"filename":{"type":"string","label":"File Name","description":"Name of file"},"from_url":{"type":"string","label":"File URL","description":"Publicly-accessible URL to file contents to upload"},"content_type":{"type":"string","label":"Content Type","description":"mimetype of file to include in multipart field"}}},"label":"Files","description":"Files to upload using multipart/form-data"},"method":{"enum":["HEAD","GET","POST","PUT","DELETE","OPTIONS","TRACE","PATCH","PURGE"],"type":"string","label":"Request Method","default":"GET","required":true,"description":"HTTP method to use."},"params":{"type":"object","label":"Params","description":"Query params to be used with the HTTP request."},"cookies":{"type":"object","label":"Cookies","description":"Cookies to send with request"},"headers":{"type":"object","label":"Headers","description":"Custom HTTP headers to be sent with the request"},"timeout":{"type":"number","label":"Timeout","default":5,"description":"Timeout for the HTTP request (seconds)."},"auth_password":{"type":"string","label":"Auth Password","secret":true,"description":"The password to be used for basic HTTP Authentication"},"auth_username":{"type":"string","label":"Auth Username","description":"The username to be used for basic HTTP Authentication"},"allow_redirects":{"type":"boolean","label":"Allow Redirects","default":true},"require_2xx_status":{"type":"boolean","label":"Require Success Status","description":"Fail the task if a non-2xx HTTP status code is returned"}},"ref":"core.http_request","icon":null,"category":"HTTP Request","workflow":null,"pack":{"__typename":"Pack","id":"79e0db69-f801-4a61-ba1f-0aa472038528","name":"Core","ref":"core","icon":null,"packType":"default","status":"published"},"outputSchema":{},"deprecated":false,"deprecationMessage":"","enabled":true,"runner":{"__typename":"Runner","name":"python-script"}},"name":"llm_data_extraction","description":"Perform an HTTP request","timeout":600,"securitySchema":{"redact":{"input":["auth_password"],"result":[]}}}}